---
title: "AFMC We Need - Text Mining Project"
subtitle: "Interim Report to AFMC"
author: "Jason Freels"
date: "2/26/2020"
output: 
  html_document:
    df_print: "paged"
    toc: true
    toc_float: yes
---

```{r setup, include=FALSE, eval=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::install_github("clawilso15/Text.Replace")
```

## Background

The "AFMC We Need" effort surveyed the AFMC workforce to capture their responses on how best to improve the MAJCOM. 

This project aims to assist AMFC analysts extract insights from this survey through development of a software package using the statistical programming environment R.

- Generate visualizations
- Automate reports

Assumptions:

- The survey data are stored in a columnar format
- Respondents are asked about how to make improvements by identifying both positive and negative trends 
- Respondents state they want to see an increased trend of positives and a decreasing trend of negatives
- Respondents will use certain phrases to identify these desires for trends

## Demo

This demo is intended to show how an intended user would interact with the package to return a desired result

This demo assumes that the user has the R programming environment installed on their machine as well as the RStudio Integrated development environment.  If this is not the case the user may refer to the AFIT guide to R to see detailed instructions on setting up their machine 

The user will first need to install the `Text.Replace` package.  This package has not yet been published to the main package repository for the R language (known as the Comprehensive R Archive Network, or CRAN. Therefore, it cannot be installed from CRAN, but can be installed from Github using the code shown below

```{r, eval=FALSE}
# If the devtools package is not already installed
# the code below installs the package from the CRAN
if(!("devtools" %in% names(installed.packages()[,"Package"]))) {
  
   install.packages("devtools")
  
}

# With the devtools package now installed we can use it 
# to install the Text.Replace package from Github  
devtools::install_github("clawilso15/Text.Replace")
```

Now that the package has been installed the user needs to load it into their working environment so that the functions contained in the package are available for use. 

```{r}
library(Text.Replace)
```

With the package installed, our first step is to extract the text data from the file in which it is contained. The `Text.Replace` package includes the `extract_text()` function to ingest text data from the following file types

- Columnar data: CSV, XLS, XLSX
- Tab Delimited: TXT
- MS Word Files: DOC, DOCX
- PDF files
- Images Files: PDF, PNG, TIF

This function is used as shown below.  The output shows an interactive table containing the first 100 rows of the survey data.

```{r, eval=FALSE}
csv = file.choose()
DATA = Text.Replace::extract_text(csv)
DT::datatable(head(DATA, 100))
```

```{r, echo=FALSE}
csv = "C:\\Users\\Aubur\\github\\auburngrads\\afmc_we_need\\data\\AWNComment_Freels.csv"
DATA = Text.Replace:::extract_text(csv)
DT::datatable(head(DATA, 100))
```

With the text data extracted from the file, we now must convert `DATA` into one or more objects that facilitate further analyses.  The objects that we want are a corpus object and a document feature matrix (DFM).  The `Text.Replace` package contains the function `create_corpus()` to create a corpus object from an object containing raw text data.  As currently implemented, this function presumes that the data are stored in a row-column format where each row (aka review) is considered as a distinct document and each column is a feature of the document.  Therefore, this function requires the user to provide the raw data object as well as the name of the column in which the the actual text is stored. All of the other columns are treated as document variables (aka `docvars`). For the case of the AWN data the survey text obtained from each respondent is stored in the 'Comments' column.

```{r}
AFMC_corpus = Text.Replace::create_corpus(DATA, "Comments")
```

Printing `AFMC_corpus` shows that the corpus object contains `r nrow(DATA)` documents and `r ncol(DATA)-1` different document variables that describe these documents. 

```{r}
AFMC_corpus
```

Next, we want to create a document feature matrix (DFM) from the corpus object. The DFM is the primary object that will be used to carry out our subsequent analyses.  The `Text.Replace` package contains the `create_dfm()` function to create the document feature matrix.  The code in the chunk below shows the arguments for this function. 

```{r}
AFMC_dfm1 = Text.Replace:::create_dfm(AFMC_corpus, 
                                     num_ngrams = 6,
                                     remove_punct = T,
                                     tolower = TRUE, 
                                     stem = FALSE, 
                                     select = NULL, 
                                     remove = NULL, 
                                     dictionary = NULL, 
                                     thesaurus = NULL, 
                                     groups = NULL)
```

It is important to note the form of the output object created by this function.  After reviewing prior work performed by AFMC analysts, we see that evaluating phrases of various lengths is important. Therefore, this function returns a list where the length of the list corresponds to the length of the `num_ngrams` object.  In the example above the function returned a list of length one that included only six-word phrases.  In the example code below, the function returns a list of length six wherein each element in the list contains phrases of length 1,2,...,6. Note that this function will take longer to evaluate.

```{r}
AFMC_dfm6 = Text.Replace:::create_dfm(AFMC_corpus, 
                                     num_ngrams = 1:6,
                                     remove_punct = T,
                                     tolower = TRUE, 
                                     stem = FALSE, 
                                     select = NULL, 
                                     remove = NULL, 
                                     dictionary = NULL, 
                                     thesaurus = NULL, 
                                     groups = NULL)
```

```{r, fig.width=10}
AFMC_dfm_Q1 = quanteda::dfm_subset(AFMC_dfm[[1]], subset = Question == 1)

AFMC_dfm_trim = quanteda::dfm_trim(AFMC_dfm_Q1, 
                                   min_termfreq = 10)
```

```{r}
# basic wordcloud
quanteda::textplot_wordcloud(AFMC_dfm_trim)

freq <- Matrix::colSums(AFMC_dfm_trim)
word <- names(freq)
freq <- unname(freq)
ord <- order(freq, decreasing = T)
word <- word[ord]
freq <- freq[ord]

df <- data.frame(term = word, frequency = freq) ; df
```

```{r, eval=FALSE}
kwic(toks, pattern = phrase(multiword))
```

```{r}
  tidy_out1 %>%
    top_n(10) %>%
    ungroup() %>%
    mutate(bigram = reorder(term, count)) %>%
    ggplot(aes(bigram, count, fill = count)) +
    geom_col(show.legend = FALSE) +
    labs(y = "Mentions",
         x = NULL) +
    coord_flip()
```